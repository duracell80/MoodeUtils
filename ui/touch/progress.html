<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>The HTML5 Herald</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint">

  <script src="js/jquery-1.8.2.min.js"></script>
    <style>
        .bar {
            background : black;
            height :2px;
            width: 0%;
            transition: width 3s;
            transition-timing-function: linear;
        }
    </style>
</head>

<body>

    <script>
        
    // mpd state and metadata
    var interval = 3000;
    var MPD = {
        json: 0
    };
     
        
    function formatSizeUnits(bytes){
      if      (bytes >= 1073741824) { bytes = (bytes / 1073741824).toFixed(2) + " GB"; }
      else if (bytes >= 1048576)    { bytes = (bytes / 1048576).toFixed(2) + " MB"; }
      else if (bytes >= 1024)       { bytes = (bytes / 1024).toFixed(2) + " KB"; }
      else if (bytes > 1)           { bytes = bytes + " bytes"; }
      else if (bytes == 1)          { bytes = bytes + " byte"; }
      else                          { bytes = "0 bytes"; }
      return bytes;
    }    
        
        
        
    function engineMpd() {

    $.ajax({
		type: 'GET',
		url: 'engine-mpd.php',
		async: true,
		cache: false,
		success: function(data) {
			
			//console.log('engineMpd: success branch: data=(' + data + ')');

			// always have valid json
			try {
				MPD.json = JSON.parse(data);
			}
			catch (e) {
				MPD.json['error'] = e;
			}

			if (typeof(MPD.json['error']) === 'undefined') {
				
                //var elapsedpc = (( MPD.json['elapsed'] / MPD.json['time'] ) * 100);
                var elapsedpc = MPD.json['song_percent'];
                
                if(elapsedpc > 90){
                    interval = 500;
                    elapsedpc = elapsedpc + 10;
                } else if (elapsedpc == 0) {
                    
                    
                    // Radio (Perpeptual) ...
                    if(MPD.json['artist'].indexOf('Radio') !== -1){
                        interval    = 5000;
                        var hours   = MPD.json['elapsed'] / 3600;
                        
                        // Beautify elapsed time for radio for hours long playback
                        if(minutes < 2) {
                            timetext = minutes + " Minute";
                        } else if(minutes < 60)  {
                            timetext = minutes + " Minutes";
                        } else {
                            var disphours = hours > 0 ? Math.floor(hours) + (hours < 2 ? " Hour, " : " Hours, ") : "";
                            timetext = disphours;
                        }
                        $('.elapsed').text(timetext);
                        
                        
                        // Do some cool stuff with estimating data usage of current playback listening based on bitrate
                        if(MPD.json['bitrate'].indexOf('kbps') !== -1){
                            var datarate    = MPD.json['bitrate'].split("kbps");
                            var dataused    = formatSizeUnits((datarate[0] * MPD.json['elapsed']) * 1024);
                            $('.bandwidth').text(dataused);
                        }
                        
                        // Do a nice trick on title change to bring progress bar to zero then back to 100
                        var last_title = $('.title').text();
                        
                        if(last_title == MPD.json['title']){
                            elapsedpc   = 100;
                            $('.icon-radio .icon-label').text("RADIO");
                        } else {
                            elapsedpc   = 0;
                            $('.icon-radio .icon-label').text("RADIO TUNE");
                        }
                        
                        
                        $('.icon-radio').show();
                        $('.bitrate').text(MPD.json['bitrate']);
                        var minutes = Math.floor(MPD.json['elapsed'] / 60);
                    
                    // Not Radio (Not Perpetual) ...   
                    } else {
                        $('.icon-radio').hide();
                        $('.elapsed').text(MPD.json['elapsed']);
                    }
                }
                
                
                var elapsed = elapsedpc + "%";
				
                
                
                
                $('#hidden').text(elapsedpc);
                $('.artist').text(MPD.json['artist']);
                $('.album').text(MPD.json['album']);
                $('.title').text(MPD.json['title']);
                
                
                
                
                
                $('.bar').css('width', elapsed);
                
            }
			// error of some sort
			else {
				

				
			}
		},
        complete: function (data) {
            // Schedule the next
            if(MPD.json['state'] != 'stop'){
				setTimeout(engineMpd, interval);    
            }
            
        },
        // network connection interrupted or client network stack timeout
		error: function(data) {
			

			
		}
    });
}  
    engineMpd(); 
    </script>
    
    <div class="icon-radio"><span class="icon-label">RADIO</span></div>
    
    
    <div class="bar"></div>
    <div class="meta">
        <ul>
            <li><span class="elapsed"></span> <span class="bitrate"></span> ( <span class="bandwidth"></span> )</li>
            <li><span class="title"></span></li>
            <li><span class="album"></span></li>
        </ul>
    </div>
    
</body>
</html>